import React, { useState, useEffect } from 'react';
import { RefreshCw, CheckCircle, XCircle, Trophy, Coins } from 'lucide-react';

// --- Components for HK Currency Graphics ---

const CurrencyNote = ({ value }) => {
  const getStyle = (val) => {
    switch (val) {
      case 1000: return { bg: 'bg-yellow-600', text: 'text-white', label: '1000' };
      case 500: return { bg: 'bg-yellow-800', text: 'text-white', label: '500' };
      case 100: return { bg: 'bg-red-500', text: 'text-white', label: '100' };
      case 50: return { bg: 'bg-green-500', text: 'text-white', label: '50' };
      case 20: return { bg: 'bg-blue-500', text: 'text-white', label: '20' };
      case 10: return { bg: 'bg-purple-500', text: 'text-white', label: '10' }; // 舊版十元紙幣或塑膠鈔
      default: return { bg: 'bg-gray-400', text: 'text-black', label: '?' };
    }
  };

  const style = getStyle(value);

  return (
    <div className={`${style.bg} ${style.text} w-24 h-14 rounded shadow-md flex items-center justify-center m-1 border-2 border-opacity-20 border-white relative transform transition hover:scale-105 select-none`}>
      <div className="absolute top-1 left-2 text-xs font-bold">{style.label}</div>
      <div className="absolute bottom-1 right-2 text-xs font-bold">{style.label}</div>
      <div className="font-bold text-xl">{style.label}</div>
      <div className="absolute text-[8px] opacity-70 bottom-1 left-2">港幣</div>
    </div>
  );
};

const CurrencyCoin = ({ value }) => {
  const getStyle = (val) => {
    // 處理浮點數精度問題
    const v = Math.round(val * 10) / 10;
    switch (v) {
      case 10: return { size: 'w-16 h-16', bg: 'bg-yellow-100', border: 'border-yellow-600', text: 'text-yellow-800', label: '10', inner: true };
      case 5: return { size: 'w-14 h-14', bg: 'bg-gray-300', border: 'border-gray-400', text: 'text-gray-700', label: '5', thick: true };
      case 2: return { size: 'w-12 h-12', bg: 'bg-gray-300', border: 'border-gray-400', text: 'text-gray-700', label: '2', wavy: true };
      case 1: return { size: 'w-10 h-10', bg: 'bg-gray-200', border: 'border-gray-300', text: 'text-gray-600', label: '1' };
      case 0.5: return { size: 'w-9 h-9', bg: 'bg-yellow-600', border: 'border-yellow-700', text: 'text-yellow-100', label: '5毫' };
      case 0.2: return { size: 'w-8 h-8', bg: 'bg-yellow-600', border: 'border-yellow-700', text: 'text-yellow-100', label: '2毫', wavy: true };
      case 0.1: return { size: 'w-6 h-6', bg: 'bg-yellow-600', border: 'border-yellow-700', text: 'text-yellow-100', label: '1毫' };
      default: return { size: 'w-10 h-10', bg: 'bg-gray-400', border: 'border-gray-500', text: 'text-white', label: '?' };
    }
  };

  const style = getStyle(value);
  const isWavy = style.wavy ? "rounded-[30%]" : "rounded-full"; // 簡單模擬波浪邊

  return (
    <div className={`${style.size} ${style.bg} ${style.text} border-4 ${style.border} ${isWavy} shadow-sm flex items-center justify-center m-1 font-bold relative transform transition hover:rotate-12 select-none`}>
      {style.inner && <div className="absolute inset-2 border-2 border-yellow-600 rounded-full opacity-50"></div>}
      {style.label}
    </div>
  );
};

// --- Main Application Logic ---

const generateQuestion = (level) => {
  let notes = [];
  let coins = [];
  
  // 隨機生成貨幣邏輯
  const r = (arr) => arr[Math.floor(Math.random() * arr.length)];
  const randCount = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;

  if (level === 1) {
    // 簡單：只有紙幣和整數硬幣
    const noteOpts = [100, 50, 20];
    const coinOpts = [10, 5, 2, 1];
    for (let i = 0; i < randCount(2, 4); i++) notes.push(r(noteOpts));
    for (let i = 0; i < randCount(1, 3); i++) coins.push(r(coinOpts));
  } else if (level === 2) {
    // 中等：加入大面額和毫子
    const noteOpts = [500, 100, 50, 20];
    const coinOpts = [10, 5, 2, 1, 0.5];
    for (let i = 0; i < randCount(2, 5); i++) notes.push(r(noteOpts));
    for (let i = 0; i < randCount(2, 5); i++) coins.push(r(coinOpts));
  } else {
    // 困難：大面額 + 複雜毫子 (0.2, 0.1)
    const noteOpts = [1000, 500, 100, 50, 20];
    const coinOpts = [10, 5, 2, 1, 0.5, 0.2, 0.1];
    for (let i = 0; i < randCount(3, 6); i++) notes.push(r(noteOpts));
    for (let i = 0; i < randCount(3, 8); i++) coins.push(r(coinOpts));
  }

  // 排序：紙幣大到小，硬幣大到小
  notes.sort((a, b) => b - a);
  coins.sort((a, b) => b - a);

  // 計算總值
  let total = notes.reduce((a, b) => a + b, 0) + coins.reduce((a, b) => a + b, 0);
  // 修正浮點數誤差
  total = Math.round(total * 10) / 10;

  const dollars = Math.floor(total);
  const cents = Math.round((total - dollars) * 10); // 轉換為「角」

  return {
    id: Date.now(),
    notes,
    coins,
    correctDollars: dollars,
    correctCents: cents,
    totalValue: total
  };
};

export default function HKCurrencyWorksheet() {
  const [level, setLevel] = useState(1);
  const [question, setQuestion] = useState(null);
  const [inputDollars, setInputDollars] = useState('');
  const [inputCents, setInputCents] = useState('');
  const [feedback, setFeedback] = useState(null); // 'correct', 'incorrect', null
  const [score, setScore] = useState(0);
  const [streak, setStreak] = useState(0);

  useEffect(() => {
    newQuestion();
  }, [level]);

  const newQuestion = () => {
    setQuestion(generateQuestion(level));
    setInputDollars('');
    setInputCents('');
    setFeedback(null);
  };

  const checkAnswer = () => {
    if (!question) return;

    const userD = parseInt(inputDollars) || 0;
    const userC = parseInt(inputCents) || 0;

    if (userD === question.correctDollars && userC === question.correctCents) {
      setFeedback('correct');
      setScore(s => s + 10 * level);
      setStreak(s => s + 1);
    } else {
      setFeedback('incorrect');
      setStreak(0);
    }
  };

  const handleLevelChange = (newLevel) => {
    setLevel(newLevel);
    setScore(0);
    setStreak(0);
  };

  if (!question) return <div className="p-10 text-center">載入中...</div>;

  return (
    <div className="min-h-screen bg-blue-50 font-sans text-gray-800 p-4 md:p-8">
      <div className="max-w-2xl mx-auto bg-white rounded-2xl shadow-xl overflow-hidden">
        
        {/* Header */}
        <div className="bg-blue-600 p-4 text-white flex justify-between items-center">
          <div className="flex items-center gap-2">
            <Coins className="w-6 h-6" />
            <h1 className="text-xl font-bold">香港貨幣計算練習</h1>
          </div>
          <div className="flex items-center gap-4">
            <div className="flex flex-col items-end">
              <span className="text-sm opacity-80">分數</span>
              <span className="font-bold text-lg">{score}</span>
            </div>
            {streak > 1 && (
              <div className="flex flex-col items-end text-yellow-300">
                <span className="text-sm opacity-80 flex items-center gap-1"><Trophy size={12}/> 連對</span>
                <span className="font-bold text-lg">{streak}</span>
              </div>
            )}
          </div>
        </div>

        {/* Level Selector */}
        <div className="flex justify-center gap-2 p-4 bg-gray-50 border-b">
          {[1, 2, 3].map(l => (
            <button
              key={l}
              onClick={() => handleLevelChange(l)}
              className={`px-4 py-1 rounded-full text-sm font-medium transition ${
                level === l 
                  ? 'bg-blue-500 text-white shadow-md' 
                  : 'bg-white text-gray-600 border hover:bg-gray-100'
              }`}
            >
              等級 {l}
            </button>
          ))}
        </div>

        {/* Game Area */}
        <div className="p-6">
          <h2 className="text-lg font-bold text-gray-700 mb-4 text-center">
            找出下列貨幣的總值
          </h2>

          {/* Money Display */}
          <div className="bg-gray-100 p-6 rounded-xl min-h-[200px] flex flex-wrap content-start gap-2 justify-center mb-8 border-inner">
            {question.notes.map((val, idx) => (
              <CurrencyNote key={`n-${idx}`} value={val} />
            ))}
            {question.coins.map((val, idx) => (
              <CurrencyCoin key={`c-${idx}`} value={val} />
            ))}
          </div>

          {/* Input Area */}
          <div className="flex flex-col items-center gap-6">
            <div className="flex items-end gap-3 text-xl font-bold">
              <div className="flex flex-col items-center">
                <label className="text-sm text-gray-500 mb-1">元</label>
                <input
                  type="number"
                  inputMode="numeric"
                  value={inputDollars}
                  onChange={(e) => setInputDollars(e.target.value)}
                  disabled={feedback === 'correct'}
                  className="w-24 h-12 text-center border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none text-2xl"
                  placeholder="0"
                />
              </div>
              <span className="pb-2 text-gray-400">元</span>
              
              <div className="flex flex-col items-center">
                <label className="text-sm text-gray-500 mb-1">角</label>
                <input
                  type="number"
                  inputMode="numeric"
                  value={inputCents}
                  onChange={(e) => setInputCents(e.target.value)}
                  disabled={feedback === 'correct'}
                  className="w-20 h-12 text-center border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none text-2xl"
                  placeholder="0"
                />
              </div>
              <span className="pb-2 text-gray-400">角</span>
            </div>

            {/* Actions & Feedback */}
            <div className="w-full flex flex-col items-center gap-4">
              {feedback === null ? (
                <button
                  onClick={checkAnswer}
                  className="w-full max-w-xs bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-xl shadow-lg transform transition active:scale-95 flex items-center justify-center gap-2"
                >
                  檢查答案
                </button>
              ) : (
                <div className={`w-full p-4 rounded-xl flex items-center justify-between ${
                  feedback === 'correct' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'
                }`}>
                  <div className="flex items-center gap-3">
                    {feedback === 'correct' ? <CheckCircle className="w-8 h-8"/> : <XCircle className="w-8 h-8"/>}
                    <div>
                      <p className="font-bold text-lg">
                        {feedback === 'correct' ? '答對了！太棒了！' : '再試一次！'}
                      </p>
                      {feedback === 'incorrect' && (
                        <p className="text-sm mt-1">
                          提示：再仔細數數看喔。
                        </p>
                      )}
                    </div>
                  </div>
                  
                  {feedback === 'correct' ? (
                    <button
                      onClick={newQuestion}
                      className="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-bold shadow flex items-center gap-2"
                    >
                      下一題 <RefreshCw size={16}/>
                    </button>
                  ) : (
                    <button
                      onClick={() => setFeedback(null)}
                      className="bg-white border border-red-300 text-red-700 px-4 py-2 rounded-lg font-bold hover:bg-red-50"
                    >
                      重試
                    </button>
                  )}
                </div>
              )}
            </div>
          </div>
        </div>

        {/* Footer */}
        <div className="bg-gray-50 p-4 text-center text-xs text-gray-500">
          參考貨幣工作紙內容製作 • 適合小學數學輔助練習
        </div>
      </div>
    </div>
  );
}